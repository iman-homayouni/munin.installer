#! /bin/bash
# Programming and idea by : Iman Homayouni
# Gitbub : https://github.com/iman-homayouni
# Email : homayouni.iman@Gmail.com
# Website : http://www.homayouni.info
# License : GPL v2.0
# Last update : Sun, 13 Jun 2021 18:25:16 +0430
# netdata.installer v1.0.1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
# SUCCESSFULLY TESTED IN UBUNTU 16.04 [XENIAL]
# SUCCESSFULLY TESTED IN UBUNTU 18.04 [BIONIC]
# SUCCESSFULLY TESTED IN UBUNTU 20.04 [FOCAL]
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# PRINT MSG TO TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
clear
echo -e "[>>] ----------------------------------------------------------- [<<]"
echo -e "[>>] Programming and idea by : Iman Homayouni                    [<<]"
echo -e "[>>] Gitbub : https://github.com/iman-homayouni                  [<<]"
echo -e "[>>] Email : homayouni.iman@Gmail.com                            [<<]"
echo -e "[>>] ----------------------------------------------------------- [<<]"
echo -e "[>>] INSTALL MUNIN IN UBUNTU 16.04 & 18.04 & 20.04               [<<]"
echo -e "[>>] ----------------------------------------------------------- [<<]"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# PRE FUNCTION # ------------------------------------------------------------------------------------------------------------------------------------------ #
function pre {
    # UPDATE AND UPGRADE SYSTEM # ------------------------------------------------------------------------------------------------------------------------- #
    apt-get update
    apt-get -y dist-upgrade
    apt -y autoremove
    apt-get -y -f install
    apt-get clean
    apt-get install net-tools
    apt-get install -y lsb-release &> /dev/null
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK lsb_release # --------------------------------------------------------------------------------------------------------------------------------- #
    which lsb_release &> /dev/null
    [ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT FIND lsb_release COMMAND\e[0m" && exit !
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK OS CODENAME # --------------------------------------------------------------------------------------------------------------------------------- #
    lsb_release -cs | grep 'focal\|bionic\|xenial' &> /dev/null
    [ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT INSTALL NETDATA IN YOUR OS\e[0m"
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}

pre

# INSTALL APACHE PACKAGE # -------------------------------------------------------------------------------------------------------------------------------- #
apt-get install -y apache2 apache2-utils
apt-get install -y libcgi-fast-perl libapache2-mod-fcgid
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CHECK fcgid MODULE # ------------------------------------------------------------------------------------------------------------------------------------ #
/usr/sbin/apachectl -M 2> /dev/null | grep -i cgi
[ "$?" != "0" ] && echo -e "[>] fcgid_module MODULE NOT FOUND" && exit 1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# ENABLE fcgid MODULE # ----------------------------------------------------------------------------------------------------------------------------------- #
a2enmod fcgid
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CHECK munin PACKAGE # ----------------------------------------------------------------------------------------------------------------------------------- #
dpkg -V munin &> /dev/null
[ "$?" = "0" ] && echo -e "\e[91m[>>] PACKAGE munin WASE INSTALLED\e[0m" && exit 1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CHECK munin-node PACKAGE # ------------------------------------------------------------------------------------------------------------------------------ #
dpkg -V munin-node &> /dev/null
[ "$?" = "0" ] && echo -e "\e[91m[>>] PACKAGE munin-node WASE INSTALLED\e[0m" && exit 1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# INSTALL munin PACKAGE # --------------------------------------------------------------------------------------------------------------------------------- #
apt-get install -y munin
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CREATE BACKUP FROM CONFIGURATION FILE # ----------------------------------------------------------------------------------------------------------------- #
cd /etc/munin
cp munin.conf munin.conf.$RANDOM.backup
cp apache24.conf apache24.conf.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CREATE munin IN APACHE # -------------------------------------------------------------------------------------------------------------------------------- #
mkdir /var/www/munin
chown munin:munin /var/www/munin
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CHANGE CONFIGURATION # ---------------------------------------------------------------------------------------------------------------------------------- #
sed -i 's/#dbdir/dbdir/g' munin.conf
sed -i 's/#htmldir/htmldir/g' munin.conf
sed -i 's/#logdir/logdir/g' munin.conf
sed -i 's/#rundir/rundir/g' munin.conf
sed -i 's/#tmpldir/tmpldir/g' munin.conf
grep -v '^#' munin.conf | grep -v '^$' > .munin.conf
mv .munin.conf munin.conf
sed -i 's/localhost.localdomain/MuninMaster/g' munin.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CREATE CONFIGURATION # ---------------------------------------------------------------------------------------------------------------------------------- #
cat << EOF > /etc/munin/apache24.conf

Alias /munin /var/cache/munin/www
<Directory /var/cache/munin/www>
    Require all granted
    Options FollowSymLinks SymLinksIfOwnerMatch
    Options None
</Directory>

ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
<Location /munin-cgi/munin-cgi-graph>
    Require all granted
    Options FollowSymLinks SymLinksIfOwnerMatch

    <IfModule mod_fcgid.c>
        SetHandler fcgid-script
    </IfModule>

    <IfModule !mod_fcgid.c>
        SetHandler cgi-script
    </IfModule>

</Location>

EOF
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# RESTART apache2 AND munin-node SERVICE # ---------------------------------------------------------------------------------------------------------------- #
systemctl restart apache2
systemctl restart munin-node
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CLEANUP TERMINAL # -------------------------------------------------------------------------------------------------------------------------------------- #
clear
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# SHOW apache2 AND munin-node STATUS # -------------------------------------------------------------------------------------------------------------------- #
systemctl status apache2
systemctl status munin-node
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# PRINT MSG TO TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
for ip in $(ifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p') ; do
    echo -e "\e[92m[>>] MUNIN URL : http://$ip/munin\e[0m"
done
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
